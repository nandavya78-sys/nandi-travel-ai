<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Nandi Travel AI</title>
<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #0b1220;
    color: #fff;
}
#app {
    display: flex;
    flex-direction: column;
    height: 100vh;
}
#chat {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
}
.msg {
    margin-bottom: 12px;
}
.user { color: #6cf; }
.bot { color: #9f9; }

#results {
    padding: 10px 20px;
}
.card {
    background: #111a2e;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
}

#inputBar {
    display: flex;
    padding: 10px;
    background: #060b16;
}
#plus {
    width: 40px;
    font-size: 20px;
}
#input {
    flex: 1;
    padding: 8px;
    font-size: 16px;
}
#send {
    padding: 8px 14px;
}

#menu {
    display: none;
    background: #111;
    padding: 10px;
}
.menu-btn {
    margin-right: 10px;
}

input, select {
    padding: 6px;
    margin-right: 6px;
}
</style>
</head>

<body>
<div id="app">

<div id="chat">
    <div class="msg bot">Hi üëã I‚Äôm Nandi Travel AI. Use + to search flights or hotels.</div>
</div>

<div id="menu">
    <button class="menu-btn" onclick="openFlights()">‚úà Flights</button>
    <button class="menu-btn" onclick="openHotels()">üè® Hotels</button>
</div>

<div id="results"></div>

<div id="inputBar">
    <button id="plus" onclick="toggleMenu()">+</button>
    <input id="input" placeholder="Ask something‚Ä¶" />
    <button id="send" onclick="sendMsg()">Send</button>
</div>

</div>

<script>
let mode = null;

function addMsg(text, cls) {
    const div = document.createElement("div");
    div.className = "msg " + cls;
    div.textContent = text;
    document.getElementById("chat").appendChild(div);
    document.getElementById("chat").scrollTop = 999999;
}

function toggleMenu() {
    const m = document.getElementById("menu");
    m.style.display = m.style.display === "block" ? "none" : "block";
}

function sendMsg() {
    const input = document.getElementById("input");
    if (!input.value) return;
    addMsg(input.value, "user");
    addMsg("Use + to search flights or hotels.", "bot");
    input.value = "";
}

/* ---------- OpenStreetMap autocomplete ---------- */
async function suggest(input, listId) {
    const q = input.value;
    if (q.length < 3) return;
    const res = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${q}`
    );
    const data = await res.json();
    const list = document.getElementById(listId);
    list.innerHTML = "";
    data.slice(0, 5).forEach(p => {
        const o = document.createElement("option");
        o.value = p.display_name;
        list.appendChild(o);
    });
}

/* ---------- Flights ---------- */
function openFlights() {
    mode = "flight";
    document.getElementById("menu").style.display = "none";
    document.getElementById("results").innerHTML = `
        <h3>Flights</h3>
        <input placeholder="From" oninput="suggest(this,'fromList')" list="fromList">
        <datalist id="fromList"></datalist>

        <input placeholder="To" oninput="suggest(this,'toList')" list="toList">
        <datalist id="toList"></datalist>

        <select id="stops">
            <option value="">Any stops</option>
            <option>Non-stop</option>
            <option>1 Stop</option>
        </select>

        <input id="maxPrice" type="number" placeholder="Max price">

        <button onclick="loadFlights()">Search</button>
        <div id="cards"></div>
    `;
    addMsg("Searching flights ‚úà", "bot");
}

async function loadFlights() {
    const res = await fetch("/flight");
    let data = await res.json();

    const stops = document.getElementById("stops").value;
    const max = document.getElementById("maxPrice").value;

    if (stops)
        data = data.filter(f => f.stops === stops);
    if (max)
        data = data.filter(f => parseInt(f.price.replace(/[^0-9]/g,'')) <= max);

    renderCards(data, f =>
        `<b>${f.airline}</b><br>${f.route}<br>${f.stops}<br>‚Çπ${f.price}`
    );
}

/* ---------- Hotels ---------- */
function openHotels() {
    mode = "hotel";
    document.getElementById("menu").style.display = "none";
    document.getElementById("results").innerHTML = `
        <h3>Hotels</h3>
        <input placeholder="City" oninput="suggest(this,'cityList')" list="cityList">
        <datalist id="cityList"></datalist>

        <select id="stars">
            <option value="">Any stars</option>
            <option value="5">5‚òÖ</option>
            <option value="4">4‚òÖ</option>
            <option value="3">3‚òÖ</option>
        </select>

        <input id="hotelPrice" type="number" placeholder="Max price/night">

        <button onclick="loadHotels()">Search</button>
        <div id="cards"></div>
    `;
    addMsg("Searching hotels üè®", "bot");
}

async function loadHotels() {
    const res = await fetch("/hotel");
    let data = await res.json();

    const stars = document.getElementById("stars").value;
    const max = document.getElementById("hotelPrice").value;

    if (stars)
        data = data.filter(h => h.stars == stars);
    if (max)
        data = data.filter(h => parseInt(h.price.replace(/[^0-9]/g,'')) <= max);

    renderCards(data, h =>
        `<b>${h.name}</b><br>${h.stars}‚òÖ<br>${h.distance}<br>‚Çπ${h.price}`
    );
}

/* ---------- Render cards ---------- */
function renderCards(data, template) {
    const c = document.getElementById("cards");
    c.innerHTML = "";
    if (!data.length) {
        c.innerHTML = "No results";
        return;
    }
    data.forEach(x => {
        const d = document.createElement("div");
        d.className = "card";
        d.innerHTML = template(x);
        c.appendChild(d);
    });
}
</script>
</body>
</html>
